{"ast":null,"code":"var exec = require('child_process');\n\nvar _ = require('underscore');\n\nvar inherits = require('util').inherits;\n\nvar utils = require('./utils');\n\nvar Q = require('q');\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar slice = [].slice;\n\nvar AbstractAnsibleCommand = function () {\n  EventEmitter.call(this);\n};\n\ninherits(AbstractAnsibleCommand, EventEmitter);\n\nAbstractAnsibleCommand.prototype.exec = function (options) {\n  // Validate execution configuration\n  var errors = this.validate();\n  var self = this;\n\n  if (errors.length > 0) {\n    var error = new Error('Ansible execution was mis-configured');\n    error.reason = errors;\n    return Q.reject(error);\n  }\n\n  var deferred = Q.defer();\n  var processOptions = {};\n  if (!options) options = {};\n\n  if (options.cwd) {\n    processOptions.cwd = options.cwd;\n  } // Make Ansible output unbuffered so the stdout and stderr `data` events\n  // pickup output up more regularly\n\n\n  var unbuffered = options.buffered ? '' : 1;\n  processOptions.env = process.env;\n\n  _.extend(processOptions.env, {\n    PYTHONUNBUFFERED: unbuffered\n  });\n\n  var output = '';\n  var child = exec.spawn(this.commandName(), this.compileParams(), processOptions);\n  child.stdout.on('data', function (data) {\n    output += data.toString();\n    self.emit('stdout', data);\n  });\n  child.stderr.on('data', function (data) {\n    output += data.toString();\n    self.emit('stderr', data);\n  });\n  child.on('close', function (code) {\n    self.emit('close', code);\n    deferred.resolve({\n      code: code,\n      output: output\n    });\n  });\n  child.on('exit', function (code) {\n    if (code !== 0) {\n      deferred.reject(new Error(output, code));\n    }\n  });\n  return deferred.promise;\n};\n\nAbstractAnsibleCommand.prototype.forks = function (forks) {\n  this.config.forks = forks;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.verbose = function (level) {\n  this.config.verbose = level;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.user = function (user) {\n  this.config.user = user;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.inventory = function (inventory) {\n  this.config.inventory = inventory;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.privateKey = function (privateKey) {\n  this.config.privateKey = privateKey;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.limit = function (limit) {\n  this.config.limit = limit;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.su = function (su) {\n  this.config.su = su;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.asSudo = function () {\n  this.config.sudo = true;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.addParam = function (commandParams, param, flag) {\n  if (this.config[param]) {\n    return this.addParamValue(commandParams, this.config[param], flag);\n  }\n\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.addParamValue = function (commandParams, value, flag) {\n  commandParams = commandParams.concat('-' + flag, value);\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.addPathParam = function (commandParams, param, flag) {\n  if (this.config[param]) {\n    return this.addParamValue(commandParams, '\"' + this.config[param] + '\"', flag);\n  }\n\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.addVerbose = function (commandParams) {\n  if (this.config.verbose) {\n    commandParams = commandParams.concat('-' + this.config.verbose);\n  }\n\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.addSudo = function (commandParams) {\n  if (this.config.sudo) {\n    commandParams = commandParams.concat('-s');\n  }\n\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.commonCompileParams = function (commandParams) {\n  commandParams = this.addParam(commandParams, \"forks\", \"f\");\n  commandParams = this.addParam(commandParams, \"user\", \"u\");\n  commandParams = this.addParam(commandParams, \"inventory\", \"i\");\n  commandParams = this.addParam(commandParams, \"limit\", \"l\");\n  commandParams = this.addParam(commandParams, \"su\", \"U\");\n  commandParams = this.addPathParam(commandParams, \"privateKey\", \"-private-key\");\n  commandParams = this.addVerbose(commandParams);\n  commandParams = this.addSudo(commandParams);\n  return commandParams;\n};\n\nvar AdHoc = function () {\n  AbstractAnsibleCommand.call(this);\n\n  this.commandName = function () {\n    return 'ansible';\n  };\n\n  this.config = {};\n\n  this.module = function (module) {\n    this.config.module = module;\n    return this;\n  };\n\n  this.args = function (args, freeform) {\n    if (!_.isObject(args)) {\n      freeform = args;\n      args = null;\n    }\n\n    this.config.args = args;\n    this.config.freeform = freeform;\n    return this;\n  };\n\n  this.hosts = function (hosts) {\n    this.config.hosts = hosts;\n    return this;\n  };\n\n  this.validate = function () {\n    var errors = [];\n    var config = this.config; // Hosts are mandatory\n\n    if (_.isUndefined(config.hosts) || _.isNull(config.hosts)) {\n      errors.push('\"hosts\" must be specified');\n    } // Module is mandatory\n\n\n    if (_.isUndefined(config.module) || _.isNull(config.module)) {\n      errors.push('\"module\" must be specified');\n    }\n\n    return errors;\n  };\n\n  this.compileParams = function () {\n    var result = [this.config.hosts, '-m', this.config.module];\n\n    if (this.config.args || this.config.freeform) {\n      var args = utils.formatArgs(this.config.args, this.config.freeform);\n      result = result.concat('-a', args);\n    }\n\n    result = this.commonCompileParams(result);\n    return result;\n  };\n};\n\ninherits(AdHoc, AbstractAnsibleCommand);\n\nvar Playbook = function () {\n  AbstractAnsibleCommand.call(this);\n\n  this.commandName = function () {\n    return 'ansible-playbook';\n  };\n\n  this.config = {};\n\n  this.askPass = function () {\n    this.config.askPass = true;\n    return this;\n  };\n\n  this.askSudoPass = function () {\n    this.config.askSudoPass = true;\n    return this;\n  };\n\n  this.playbook = function (playbook) {\n    this.config.playbook = playbook;\n    return this;\n  };\n\n  this.variables = function (variables) {\n    this.config.variables = variables;\n    return this;\n  };\n\n  this.tags = function () {\n    var args;\n    args = 1 <= arguments.length ? slice.call(arguments, 0) : [];\n    if (_.isString(args)) args = Array(args);\n    this.config.tags = args;\n    return this;\n  };\n\n  this.skipTags = function () {\n    var args;\n    args = 1 <= arguments.length ? slice.call(arguments, 0) : [];\n    if (_.isString(args)) args = Array(args);\n    this.config.skipTags = args;\n    return this;\n  };\n\n  this.addTags = function () {\n    return '--tags=' + this.config.tags.join(',');\n  };\n\n  this.addSkipTags = function () {\n    return '--skip-tags=' + this.config.skipTags.join(',');\n  };\n\n  this.validate = function () {\n    var errors = []; // Playbook is mandatory\n\n    if (_.isUndefined(this.config.playbook) || _.isNull(this.config.playbook)) {\n      errors.push(\"'playbook' must be specified\");\n    }\n\n    return errors;\n  };\n\n  this.compileParams = function () {\n    var result = [this.config.playbook + \".yml\"];\n\n    if (this.config.variables) {\n      var args = JSON.stringify(this.config.variables);\n      result = result.concat('-e', args);\n    }\n\n    if (this.config.askPass) {\n      result = result.concat('--ask-pass');\n    }\n\n    if (this.config.askSudoPass) {\n      result = result.concat('--ask-sudo-pass');\n    }\n\n    if (this.config.tags) {\n      var tags = this.addTags();\n      result = result.concat(tags);\n    }\n\n    if (this.config.skipTags) {\n      var skipTags = this.addSkipTags();\n      result = result.concat(skipTags);\n    }\n\n    result = this.commonCompileParams(result);\n    return result;\n  };\n};\n\ninherits(Playbook, AbstractAnsibleCommand);\nmodule.exports.AdHoc = AdHoc;\nmodule.exports.Playbook = Playbook;","map":{"version":3,"sources":["/Users/hari/Desktop/workspace/react_workspace/ci_tools_ui/node_modules/node-ansible/lib/ansible.js"],"names":["exec","require","_","inherits","utils","Q","EventEmitter","slice","AbstractAnsibleCommand","call","prototype","options","errors","validate","self","length","error","Error","reason","reject","deferred","defer","processOptions","cwd","unbuffered","buffered","env","process","extend","PYTHONUNBUFFERED","output","child","spawn","commandName","compileParams","stdout","on","data","toString","emit","stderr","code","resolve","promise","forks","config","verbose","level","user","inventory","privateKey","limit","su","asSudo","sudo","addParam","commandParams","param","flag","addParamValue","value","concat","addPathParam","addVerbose","addSudo","commonCompileParams","AdHoc","module","args","freeform","isObject","hosts","isUndefined","isNull","push","result","formatArgs","Playbook","askPass","askSudoPass","playbook","variables","tags","arguments","isString","Array","skipTags","addTags","join","addSkipTags","JSON","stringify","exports"],"mappings":"AAAA,IAAIA,IAAI,GAAGC,OAAO,CAAC,eAAD,CAAlB;;AACA,IAAIC,CAAC,GAAGD,OAAO,CAAC,YAAD,CAAf;;AACA,IAAIE,QAAQ,GAAGF,OAAO,CAAC,MAAD,CAAP,CAAgBE,QAA/B;;AACA,IAAIC,KAAK,GAAGH,OAAO,CAAC,SAAD,CAAnB;;AACA,IAAII,CAAC,GAAGJ,OAAO,CAAC,GAAD,CAAf;;AACA,IAAIK,YAAY,GAAGL,OAAO,CAAC,QAAD,CAAP,CAAkBK,YAArC;;AACA,IAAIC,KAAK,GAAG,GAAGA,KAAf;;AAEA,IAAIC,sBAAsB,GAAG,YAAW;AACtCF,EAAAA,YAAY,CAACG,IAAb,CAAkB,IAAlB;AACD,CAFD;;AAIAN,QAAQ,CAACK,sBAAD,EAAyBF,YAAzB,CAAR;;AAEAE,sBAAsB,CAACE,SAAvB,CAAiCV,IAAjC,GAAwC,UAASW,OAAT,EAAkB;AACxD;AACA,MAAIC,MAAM,GAAG,KAAKC,QAAL,EAAb;AACA,MAAIC,IAAI,GAAG,IAAX;;AACA,MAAIF,MAAM,CAACG,MAAP,GAAgB,CAApB,EAAuB;AACrB,QAAIC,KAAK,GAAG,IAAIC,KAAJ,CAAU,sCAAV,CAAZ;AACAD,IAAAA,KAAK,CAACE,MAAN,GAAeN,MAAf;AACA,WAAOP,CAAC,CAACc,MAAF,CAASH,KAAT,CAAP;AACD;;AAED,MAAII,QAAQ,GAAGf,CAAC,CAACgB,KAAF,EAAf;AACA,MAAIC,cAAc,GAAG,EAArB;AACA,MAAI,CAACX,OAAL,EAAcA,OAAO,GAAG,EAAV;;AAEd,MAAIA,OAAO,CAACY,GAAZ,EAAiB;AACfD,IAAAA,cAAc,CAACC,GAAf,GAAqBZ,OAAO,CAACY,GAA7B;AACD,GAhBuD,CAkBxD;AACA;;;AACA,MAAIC,UAAU,GAAIb,OAAO,CAACc,QAAT,GAAqB,EAArB,GAA0B,CAA3C;AACAH,EAAAA,cAAc,CAACI,GAAf,GAAqBC,OAAO,CAACD,GAA7B;;AACAxB,EAAAA,CAAC,CAAC0B,MAAF,CAAUN,cAAc,CAACI,GAAzB,EAA8B;AAAEG,IAAAA,gBAAgB,EAAEL;AAApB,GAA9B;;AAEA,MAAIM,MAAM,GAAG,EAAb;AACA,MAAIC,KAAK,GAAG/B,IAAI,CAACgC,KAAL,CAAW,KAAKC,WAAL,EAAX,EAA+B,KAAKC,aAAL,EAA/B,EAAqDZ,cAArD,CAAZ;AAEAS,EAAAA,KAAK,CAACI,MAAN,CAAaC,EAAb,CAAgB,MAAhB,EAAwB,UAASC,IAAT,EAAe;AACrCP,IAAAA,MAAM,IAAIO,IAAI,CAACC,QAAL,EAAV;AACAxB,IAAAA,IAAI,CAACyB,IAAL,CAAU,QAAV,EAAoBF,IAApB;AACD,GAHD;AAKAN,EAAAA,KAAK,CAACS,MAAN,CAAaJ,EAAb,CAAgB,MAAhB,EAAwB,UAASC,IAAT,EAAe;AACrCP,IAAAA,MAAM,IAAIO,IAAI,CAACC,QAAL,EAAV;AACAxB,IAAAA,IAAI,CAACyB,IAAL,CAAU,QAAV,EAAoBF,IAApB;AACD,GAHD;AAKAN,EAAAA,KAAK,CAACK,EAAN,CAAS,OAAT,EAAkB,UAASK,IAAT,EAAe;AAC/B3B,IAAAA,IAAI,CAACyB,IAAL,CAAU,OAAV,EAAmBE,IAAnB;AACArB,IAAAA,QAAQ,CAACsB,OAAT,CAAiB;AAACD,MAAAA,IAAI,EAAEA,IAAP;AAAaX,MAAAA,MAAM,EAAEA;AAArB,KAAjB;AACD,GAHD;AAKAC,EAAAA,KAAK,CAACK,EAAN,CAAS,MAAT,EAAiB,UAASK,IAAT,EAAe;AAC9B,QAAIA,IAAI,KAAK,CAAb,EAAgB;AACdrB,MAAAA,QAAQ,CAACD,MAAT,CAAgB,IAAIF,KAAJ,CAAUa,MAAV,EAAkBW,IAAlB,CAAhB;AACD;AACF,GAJD;AAMA,SAAOrB,QAAQ,CAACuB,OAAhB;AACD,CAjDD;;AAmDAnC,sBAAsB,CAACE,SAAvB,CAAiCkC,KAAjC,GAAyC,UAASA,KAAT,EAAgB;AACvD,OAAKC,MAAL,CAAYD,KAAZ,GAAoBA,KAApB;AACA,SAAO,IAAP;AACD,CAHD;;AAKApC,sBAAsB,CAACE,SAAvB,CAAiCoC,OAAjC,GAA2C,UAASC,KAAT,EAAgB;AACzD,OAAKF,MAAL,CAAYC,OAAZ,GAAsBC,KAAtB;AACA,SAAO,IAAP;AACD,CAHD;;AAKAvC,sBAAsB,CAACE,SAAvB,CAAiCsC,IAAjC,GAAwC,UAASA,IAAT,EAAe;AACrD,OAAKH,MAAL,CAAYG,IAAZ,GAAmBA,IAAnB;AACA,SAAO,IAAP;AACD,CAHD;;AAKAxC,sBAAsB,CAACE,SAAvB,CAAiCuC,SAAjC,GAA6C,UAASA,SAAT,EAAoB;AAC/D,OAAKJ,MAAL,CAAYI,SAAZ,GAAwBA,SAAxB;AACA,SAAO,IAAP;AACD,CAHD;;AAKAzC,sBAAsB,CAACE,SAAvB,CAAiCwC,UAAjC,GAA8C,UAASA,UAAT,EAAqB;AACjE,OAAKL,MAAL,CAAYK,UAAZ,GAAyBA,UAAzB;AACA,SAAO,IAAP;AACD,CAHD;;AAKA1C,sBAAsB,CAACE,SAAvB,CAAiCyC,KAAjC,GAAyC,UAASA,KAAT,EAAgB;AACvD,OAAKN,MAAL,CAAYM,KAAZ,GAAoBA,KAApB;AACA,SAAO,IAAP;AACD,CAHD;;AAKA3C,sBAAsB,CAACE,SAAvB,CAAiC0C,EAAjC,GAAsC,UAASA,EAAT,EAAa;AACjD,OAAKP,MAAL,CAAYO,EAAZ,GAAiBA,EAAjB;AACA,SAAO,IAAP;AACD,CAHD;;AAKA5C,sBAAsB,CAACE,SAAvB,CAAiC2C,MAAjC,GAA0C,YAAW;AACnD,OAAKR,MAAL,CAAYS,IAAZ,GAAmB,IAAnB;AACA,SAAO,IAAP;AACD,CAHD;;AAKA9C,sBAAsB,CAACE,SAAvB,CAAiC6C,QAAjC,GAA4C,UAASC,aAAT,EAAwBC,KAAxB,EAA+BC,IAA/B,EAAqC;AAC/E,MAAI,KAAKb,MAAL,CAAYY,KAAZ,CAAJ,EAAwB;AACtB,WAAO,KAAKE,aAAL,CAAmBH,aAAnB,EAAkC,KAAKX,MAAL,CAAYY,KAAZ,CAAlC,EAAsDC,IAAtD,CAAP;AACD;;AACD,SAAOF,aAAP;AACD,CALD;;AAOAhD,sBAAsB,CAACE,SAAvB,CAAiCiD,aAAjC,GAAiD,UAASH,aAAT,EAAwBI,KAAxB,EAA+BF,IAA/B,EAAqC;AACpFF,EAAAA,aAAa,GAAGA,aAAa,CAACK,MAAd,CAAqB,MAAMH,IAA3B,EAAiCE,KAAjC,CAAhB;AACA,SAAOJ,aAAP;AACD,CAHD;;AAKAhD,sBAAsB,CAACE,SAAvB,CAAiCoD,YAAjC,GAAgD,UAASN,aAAT,EAAwBC,KAAxB,EAA+BC,IAA/B,EAAqC;AACnF,MAAI,KAAKb,MAAL,CAAYY,KAAZ,CAAJ,EAAwB;AACtB,WAAO,KAAKE,aAAL,CAAmBH,aAAnB,EAAkC,MAAM,KAAKX,MAAL,CAAYY,KAAZ,CAAN,GAA2B,GAA7D,EAAkEC,IAAlE,CAAP;AACD;;AACD,SAAOF,aAAP;AACD,CALD;;AAOAhD,sBAAsB,CAACE,SAAvB,CAAiCqD,UAAjC,GAA8C,UAASP,aAAT,EAAwB;AACpE,MAAI,KAAKX,MAAL,CAAYC,OAAhB,EAAyB;AACvBU,IAAAA,aAAa,GAAGA,aAAa,CAACK,MAAd,CAAqB,MAAM,KAAKhB,MAAL,CAAYC,OAAvC,CAAhB;AACD;;AACD,SAAOU,aAAP;AACD,CALD;;AAOAhD,sBAAsB,CAACE,SAAvB,CAAiCsD,OAAjC,GAA2C,UAASR,aAAT,EAAwB;AACjE,MAAI,KAAKX,MAAL,CAAYS,IAAhB,EAAsB;AACpBE,IAAAA,aAAa,GAAGA,aAAa,CAACK,MAAd,CAAqB,IAArB,CAAhB;AACD;;AACD,SAAOL,aAAP;AACD,CALD;;AAOAhD,sBAAsB,CAACE,SAAvB,CAAiCuD,mBAAjC,GAAuD,UAAST,aAAT,EAAwB;AAC7EA,EAAAA,aAAa,GAAG,KAAKD,QAAL,CAAcC,aAAd,EAA6B,OAA7B,EAAsC,GAAtC,CAAhB;AACAA,EAAAA,aAAa,GAAG,KAAKD,QAAL,CAAcC,aAAd,EAA6B,MAA7B,EAAqC,GAArC,CAAhB;AACAA,EAAAA,aAAa,GAAG,KAAKD,QAAL,CAAcC,aAAd,EAA6B,WAA7B,EAA0C,GAA1C,CAAhB;AACAA,EAAAA,aAAa,GAAG,KAAKD,QAAL,CAAcC,aAAd,EAA6B,OAA7B,EAAsC,GAAtC,CAAhB;AACAA,EAAAA,aAAa,GAAG,KAAKD,QAAL,CAAcC,aAAd,EAA6B,IAA7B,EAAmC,GAAnC,CAAhB;AACAA,EAAAA,aAAa,GAAG,KAAKM,YAAL,CAAkBN,aAAlB,EAAiC,YAAjC,EAA+C,cAA/C,CAAhB;AACAA,EAAAA,aAAa,GAAG,KAAKO,UAAL,CAAgBP,aAAhB,CAAhB;AACAA,EAAAA,aAAa,GAAG,KAAKQ,OAAL,CAAaR,aAAb,CAAhB;AAEA,SAAOA,aAAP;AACD,CAXD;;AAaA,IAAIU,KAAK,GAAG,YAAW;AAErB1D,EAAAA,sBAAsB,CAACC,IAAvB,CAA4B,IAA5B;;AAEA,OAAKwB,WAAL,GAAmB,YAAW;AAC5B,WAAO,SAAP;AACD,GAFD;;AAIA,OAAKY,MAAL,GAAc,EAAd;;AAEA,OAAKsB,MAAL,GAAc,UAAUA,MAAV,EAAkB;AAC9B,SAAKtB,MAAL,CAAYsB,MAAZ,GAAqBA,MAArB;AACA,WAAO,IAAP;AACD,GAHD;;AAKA,OAAKC,IAAL,GAAY,UAAUA,IAAV,EAAgBC,QAAhB,EAA0B;AACpC,QAAI,CAACnE,CAAC,CAACoE,QAAF,CAAWF,IAAX,CAAL,EAAuB;AACrBC,MAAAA,QAAQ,GAAGD,IAAX;AACAA,MAAAA,IAAI,GAAG,IAAP;AACD;;AAED,SAAKvB,MAAL,CAAYuB,IAAZ,GAAmBA,IAAnB;AACA,SAAKvB,MAAL,CAAYwB,QAAZ,GAAuBA,QAAvB;AACA,WAAO,IAAP;AACD,GATD;;AAWA,OAAKE,KAAL,GAAa,UAAUA,KAAV,EAAiB;AAC5B,SAAK1B,MAAL,CAAY0B,KAAZ,GAAoBA,KAApB;AACA,WAAO,IAAP;AACD,GAHD;;AAKA,OAAK1D,QAAL,GAAgB,YAAY;AAC1B,QAAID,MAAM,GAAG,EAAb;AACA,QAAIiC,MAAM,GAAG,KAAKA,MAAlB,CAF0B,CAI1B;;AACA,QAAI3C,CAAC,CAACsE,WAAF,CAAc3B,MAAM,CAAC0B,KAArB,KAA+BrE,CAAC,CAACuE,MAAF,CAAS5B,MAAM,CAAC0B,KAAhB,CAAnC,EAA2D;AACzD3D,MAAAA,MAAM,CAAC8D,IAAP,CAAY,2BAAZ;AACD,KAPyB,CAS1B;;;AACA,QAAIxE,CAAC,CAACsE,WAAF,CAAc3B,MAAM,CAACsB,MAArB,KAAgCjE,CAAC,CAACuE,MAAF,CAAS5B,MAAM,CAACsB,MAAhB,CAApC,EAA6D;AAC3DvD,MAAAA,MAAM,CAAC8D,IAAP,CAAY,4BAAZ;AACD;;AAED,WAAO9D,MAAP;AACD,GAfD;;AAiBA,OAAKsB,aAAL,GAAqB,YAAW;AAC9B,QAAIyC,MAAM,GAAG,CACX,KAAK9B,MAAL,CAAY0B,KADD,EAEX,IAFW,EAGX,KAAK1B,MAAL,CAAYsB,MAHD,CAAb;;AAMA,QAAI,KAAKtB,MAAL,CAAYuB,IAAZ,IAAoB,KAAKvB,MAAL,CAAYwB,QAApC,EAA8C;AAC5C,UAAID,IAAI,GAAGhE,KAAK,CAACwE,UAAN,CAAiB,KAAK/B,MAAL,CAAYuB,IAA7B,EAAmC,KAAKvB,MAAL,CAAYwB,QAA/C,CAAX;AACAM,MAAAA,MAAM,GAAGA,MAAM,CAACd,MAAP,CAAc,IAAd,EAAoBO,IAApB,CAAT;AACD;;AAEDO,IAAAA,MAAM,GAAG,KAAKV,mBAAL,CAAyBU,MAAzB,CAAT;AAEA,WAAOA,MAAP;AACD,GAfD;AAiBD,CAjED;;AAmEAxE,QAAQ,CAAC+D,KAAD,EAAQ1D,sBAAR,CAAR;;AAEA,IAAIqE,QAAQ,GAAG,YAAY;AAEzBrE,EAAAA,sBAAsB,CAACC,IAAvB,CAA4B,IAA5B;;AAEA,OAAKwB,WAAL,GAAmB,YAAW;AAC5B,WAAO,kBAAP;AACD,GAFD;;AAIA,OAAKY,MAAL,GAAc,EAAd;;AAEA,OAAKiC,OAAL,GAAe,YAAW;AACxB,SAAKjC,MAAL,CAAYiC,OAAZ,GAAsB,IAAtB;AACA,WAAO,IAAP;AACD,GAHD;;AAKA,OAAKC,WAAL,GAAmB,YAAW;AAC5B,SAAKlC,MAAL,CAAYkC,WAAZ,GAA0B,IAA1B;AACA,WAAO,IAAP;AACD,GAHD;;AAKA,OAAKC,QAAL,GAAgB,UAASA,QAAT,EAAmB;AACjC,SAAKnC,MAAL,CAAYmC,QAAZ,GAAuBA,QAAvB;AACA,WAAO,IAAP;AACD,GAHD;;AAKA,OAAKC,SAAL,GAAiB,UAASA,SAAT,EAAoB;AACnC,SAAKpC,MAAL,CAAYoC,SAAZ,GAAwBA,SAAxB;AACA,WAAO,IAAP;AACD,GAHD;;AAKA,OAAKC,IAAL,GAAY,YAAW;AACrB,QAAId,IAAJ;AACAA,IAAAA,IAAI,GAAG,KAAKe,SAAS,CAACpE,MAAf,GAAwBR,KAAK,CAACE,IAAN,CAAW0E,SAAX,EAAsB,CAAtB,CAAxB,GAAmD,EAA1D;AACA,QAAKjF,CAAC,CAACkF,QAAF,CAAWhB,IAAX,CAAL,EAAwBA,IAAI,GAAGiB,KAAK,CAACjB,IAAD,CAAZ;AACxB,SAAKvB,MAAL,CAAYqC,IAAZ,GAAmBd,IAAnB;AACA,WAAO,IAAP;AACD,GAND;;AAQA,OAAKkB,QAAL,GAAgB,YAAW;AACzB,QAAIlB,IAAJ;AACAA,IAAAA,IAAI,GAAG,KAAKe,SAAS,CAACpE,MAAf,GAAwBR,KAAK,CAACE,IAAN,CAAW0E,SAAX,EAAsB,CAAtB,CAAxB,GAAmD,EAA1D;AACA,QAAKjF,CAAC,CAACkF,QAAF,CAAWhB,IAAX,CAAL,EAAwBA,IAAI,GAAGiB,KAAK,CAACjB,IAAD,CAAZ;AACxB,SAAKvB,MAAL,CAAYyC,QAAZ,GAAuBlB,IAAvB;AACA,WAAO,IAAP;AACD,GAND;;AAQA,OAAKmB,OAAL,GAAe,YAAW;AACxB,WAAQ,YAAY,KAAK1C,MAAL,CAAYqC,IAAZ,CAAiBM,IAAjB,CAAsB,GAAtB,CAApB;AACD,GAFD;;AAIA,OAAKC,WAAL,GAAmB,YAAW;AAC5B,WAAQ,iBAAiB,KAAK5C,MAAL,CAAYyC,QAAZ,CAAqBE,IAArB,CAA0B,GAA1B,CAAzB;AACD,GAFD;;AAIA,OAAK3E,QAAL,GAAgB,YAAW;AACzB,QAAID,MAAM,GAAG,EAAb,CADyB,CAGzB;;AACA,QAAIV,CAAC,CAACsE,WAAF,CAAc,KAAK3B,MAAL,CAAYmC,QAA1B,KAAuC9E,CAAC,CAACuE,MAAF,CAAS,KAAK5B,MAAL,CAAYmC,QAArB,CAA3C,EAA2E;AACzEpE,MAAAA,MAAM,CAAC8D,IAAP,CAAY,8BAAZ;AACD;;AAED,WAAO9D,MAAP;AACD,GATD;;AAWA,OAAKsB,aAAL,GAAqB,YAAW;AAC9B,QAAIyC,MAAM,GAAG,CACX,KAAK9B,MAAL,CAAYmC,QAAZ,GAAuB,MADZ,CAAb;;AAIA,QAAI,KAAKnC,MAAL,CAAYoC,SAAhB,EAA2B;AACzB,UAAIb,IAAI,GAAGsB,IAAI,CAACC,SAAL,CAAe,KAAK9C,MAAL,CAAYoC,SAA3B,CAAX;AACAN,MAAAA,MAAM,GAAGA,MAAM,CAACd,MAAP,CAAc,IAAd,EAAoBO,IAApB,CAAT;AACD;;AAED,QAAI,KAAKvB,MAAL,CAAYiC,OAAhB,EAAyB;AACvBH,MAAAA,MAAM,GAAGA,MAAM,CAACd,MAAP,CAAc,YAAd,CAAT;AACD;;AAED,QAAI,KAAKhB,MAAL,CAAYkC,WAAhB,EAA6B;AAC3BJ,MAAAA,MAAM,GAAGA,MAAM,CAACd,MAAP,CAAc,iBAAd,CAAT;AACD;;AAED,QAAI,KAAKhB,MAAL,CAAYqC,IAAhB,EAAsB;AACpB,UAAIA,IAAI,GAAG,KAAKK,OAAL,EAAX;AACAZ,MAAAA,MAAM,GAAGA,MAAM,CAACd,MAAP,CAAcqB,IAAd,CAAT;AACD;;AAED,QAAI,KAAKrC,MAAL,CAAYyC,QAAhB,EAA0B;AACxB,UAAIA,QAAQ,GAAG,KAAKG,WAAL,EAAf;AACAd,MAAAA,MAAM,GAAGA,MAAM,CAACd,MAAP,CAAcyB,QAAd,CAAT;AACD;;AAEDX,IAAAA,MAAM,GAAG,KAAKV,mBAAL,CAAyBU,MAAzB,CAAT;AAEA,WAAOA,MAAP;AACD,GA/BD;AAgCD,CAjGD;;AAmGAxE,QAAQ,CAAC0E,QAAD,EAAWrE,sBAAX,CAAR;AAEA2D,MAAM,CAACyB,OAAP,CAAe1B,KAAf,GAAuBA,KAAvB;AACAC,MAAM,CAACyB,OAAP,CAAef,QAAf,GAA0BA,QAA1B","sourcesContent":["var exec = require('child_process');\nvar _ = require('underscore');\nvar inherits = require('util').inherits;\nvar utils = require('./utils');\nvar Q = require('q');\nvar EventEmitter = require('events').EventEmitter;\nvar slice = [].slice;\n\nvar AbstractAnsibleCommand = function() {\n  EventEmitter.call(this);\n};\n\ninherits(AbstractAnsibleCommand, EventEmitter);\n\nAbstractAnsibleCommand.prototype.exec = function(options) {\n  // Validate execution configuration\n  var errors = this.validate();\n  var self = this;\n  if (errors.length > 0) {\n    var error = new Error('Ansible execution was mis-configured');\n    error.reason = errors;\n    return Q.reject(error)\n  }\n\n  var deferred = Q.defer();\n  var processOptions = {};\n  if (!options) options = {};\n\n  if (options.cwd) {\n    processOptions.cwd = options.cwd;\n  }\n\n  // Make Ansible output unbuffered so the stdout and stderr `data` events\n  // pickup output up more regularly\n  var unbuffered = (options.buffered) ? '' : 1;\n  processOptions.env = process.env;\n  _.extend( processOptions.env, { PYTHONUNBUFFERED: unbuffered } );\n\n  var output = '';\n  var child = exec.spawn(this.commandName(), this.compileParams(), processOptions);\n\n  child.stdout.on('data', function(data) {\n    output += data.toString();\n    self.emit('stdout', data);\n  });\n\n  child.stderr.on('data', function(data) {\n    output += data.toString();\n    self.emit('stderr', data);\n  });\n\n  child.on('close', function(code) {\n    self.emit('close', code);\n    deferred.resolve({code: code, output: output});\n  });\n\n  child.on('exit', function(code) {\n    if (code !== 0) {\n      deferred.reject(new Error(output, code));\n    }\n  });\n\n  return deferred.promise;\n};\n\nAbstractAnsibleCommand.prototype.forks = function(forks) {\n  this.config.forks = forks;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.verbose = function(level) {\n  this.config.verbose = level;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.user = function(user) {\n  this.config.user = user;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.inventory = function(inventory) {\n  this.config.inventory = inventory;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.privateKey = function(privateKey) {\n  this.config.privateKey = privateKey;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.limit = function(limit) {\n  this.config.limit = limit;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.su = function(su) {\n  this.config.su = su;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.asSudo = function() {\n  this.config.sudo = true;\n  return this;\n};\n\nAbstractAnsibleCommand.prototype.addParam = function(commandParams, param, flag) {\n  if (this.config[param]) {\n    return this.addParamValue(commandParams, this.config[param], flag)\n  }\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.addParamValue = function(commandParams, value, flag) {\n  commandParams = commandParams.concat('-' + flag, value);\n  return commandParams;\n}\n\nAbstractAnsibleCommand.prototype.addPathParam = function(commandParams, param, flag) {\n  if (this.config[param]) {\n    return this.addParamValue(commandParams, '\"' + this.config[param] + '\"', flag);\n  }\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.addVerbose = function(commandParams) {\n  if (this.config.verbose) {\n    commandParams = commandParams.concat('-' + this.config.verbose);\n  }\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.addSudo = function(commandParams) {\n  if (this.config.sudo) {\n    commandParams = commandParams.concat('-s');\n  }\n  return commandParams;\n};\n\nAbstractAnsibleCommand.prototype.commonCompileParams = function(commandParams) {\n  commandParams = this.addParam(commandParams, \"forks\", \"f\");\n  commandParams = this.addParam(commandParams, \"user\", \"u\");\n  commandParams = this.addParam(commandParams, \"inventory\", \"i\");\n  commandParams = this.addParam(commandParams, \"limit\", \"l\");\n  commandParams = this.addParam(commandParams, \"su\", \"U\");\n  commandParams = this.addPathParam(commandParams, \"privateKey\", \"-private-key\");\n  commandParams = this.addVerbose(commandParams);\n  commandParams = this.addSudo(commandParams);\n\n  return commandParams;\n};\n\nvar AdHoc = function() {\n\n  AbstractAnsibleCommand.call(this);\n\n  this.commandName = function() {\n    return 'ansible';\n  }\n\n  this.config = {};\n\n  this.module = function (module) {\n    this.config.module = module;\n    return this;\n  }\n\n  this.args = function (args, freeform) {\n    if (!_.isObject(args)) {\n      freeform = args;\n      args = null;\n    }\n\n    this.config.args = args;\n    this.config.freeform = freeform;\n    return this;\n  }\n\n  this.hosts = function (hosts) {\n    this.config.hosts = hosts;\n    return this;\n  }\n\n  this.validate = function () {\n    var errors = [];\n    var config = this.config;\n\n    // Hosts are mandatory\n    if (_.isUndefined(config.hosts) || _.isNull(config.hosts)) {\n      errors.push('\"hosts\" must be specified');\n    }\n\n    // Module is mandatory\n    if (_.isUndefined(config.module) || _.isNull(config.module)) {\n      errors.push('\"module\" must be specified');\n    }\n\n    return errors;\n  }\n\n  this.compileParams = function() {\n    var result = [\n      this.config.hosts,\n      '-m',\n      this.config.module\n    ];\n\n    if (this.config.args || this.config.freeform) {\n      var args = utils.formatArgs(this.config.args, this.config.freeform);\n      result = result.concat('-a', args);\n    }\n\n    result = this.commonCompileParams(result);\n\n    return result;\n  }\n\n}\n\ninherits(AdHoc, AbstractAnsibleCommand);\n\nvar Playbook = function () {\n\n  AbstractAnsibleCommand.call(this);\n\n  this.commandName = function() {\n    return 'ansible-playbook';\n  }\n\n  this.config = {};\n\n  this.askPass = function() {\n    this.config.askPass = true;\n    return this;\n  }\n\n  this.askSudoPass = function() {\n    this.config.askSudoPass = true;\n    return this;\n  }\n\n  this.playbook = function(playbook) {\n    this.config.playbook = playbook;\n    return this;\n  }\n\n  this.variables = function(variables) {\n    this.config.variables = variables;\n    return this;\n  }\n\n  this.tags = function() {\n    var args\n    args = 1 <= arguments.length ? slice.call(arguments, 0) : [];\n    if ( _.isString(args) ) args = Array(args);\n    this.config.tags = args;\n    return this;\n  }\n\n  this.skipTags = function() {\n    var args\n    args = 1 <= arguments.length ? slice.call(arguments, 0) : [];\n    if ( _.isString(args) ) args = Array(args);\n    this.config.skipTags = args;\n    return this;\n  }\n\n  this.addTags = function() {\n    return ('--tags=' + this.config.tags.join(','));\n  }\n\n  this.addSkipTags = function() {\n    return ('--skip-tags=' + this.config.skipTags.join(','));\n  }\n\n  this.validate = function() {\n    var errors = [];\n\n    // Playbook is mandatory\n    if (_.isUndefined(this.config.playbook) || _.isNull(this.config.playbook)) {\n      errors.push(\"'playbook' must be specified\")\n    }\n\n    return errors;\n  }\n\n  this.compileParams = function() {\n    var result = [\n      this.config.playbook + \".yml\"\n    ];\n\n    if (this.config.variables) {\n      var args = JSON.stringify(this.config.variables);\n      result = result.concat('-e', args);\n    }\n\n    if (this.config.askPass) {\n      result = result.concat('--ask-pass');\n    }\n\n    if (this.config.askSudoPass) {\n      result = result.concat('--ask-sudo-pass');\n    }\n\n    if (this.config.tags) {\n      var tags = this.addTags();\n      result = result.concat(tags);\n    }\n\n    if (this.config.skipTags) {\n      var skipTags = this.addSkipTags();\n      result = result.concat(skipTags);\n    }\n\n    result = this.commonCompileParams(result);\n\n    return result;\n  }\n}\n\ninherits(Playbook, AbstractAnsibleCommand);\n\nmodule.exports.AdHoc = AdHoc;\nmodule.exports.Playbook = Playbook;\n"]},"metadata":{},"sourceType":"script"}